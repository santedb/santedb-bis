<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="~/.ref/schema/BusinessIntelligence.xsd" type="application/xml" schematypens="http://www.w3.org/2001/XMLSchema"?>
<BiDatamartDefinition xmlns="http://santedb.org/bi" id="org.santedb.bi.datamart.core"
    name="core-datamart" label="core-datamart">


  <meta status="active" version="3.0">
    <authors>
      <add>SanteSuite Inc. and the SanteSuite Contributors</add>
    </authors>
    <annotation>
      <div xmlns="http://www.w3.org/1999/xhtml">
        <p>
          This transform definition is responsible for populating the default SanteDB data mart schema from which most default SanteDB reports and
          informational assets are derived. You can extend this data mart by defining your own "based on" this data-mart which will re-use all the
          tables, views and transforms contained in this definition
        </p>
      </div>
    </annotation>
    <public>true</public>
  </meta>


  <produces id="org.santedb.bi.dataSource.warehouse" name="warehouse">
    <meta status="active">
      <policies>
        <!-- This requires query clinical data -->
        <demand>1.3.6.1.4.1.33349.3.1.5.9.2.2.0</demand>
      </policies>
    </meta>
  </produces>


  <schema>

    <table name="REJECT_TBL">
      <column type="uuid" key="true" notNull="true" unique="true" name="RECORD_ID"/>
      <column type="string" name="TYPE" />
      <column type="string" name="REASON" />
    </table>

    <table name="SEC_USR_TBL">
      <column type="uuid" key="true" notNull="true" unique="true" name="USR_ID"/>
      <column type="string" notNull="true" name="USERNAME" />
      <column type="date-time" notNull="true" name="CREATED_TIME" />
      <column type="ref" notNull="true" name="CREATED_BY">
        <otherTable ref="SEC_USR_TBL" />
      </column>
      <column type="date-time" name="LAST_LOGIN_DATE" />
      <column type="string" name="EMAIL" />
      <column type="string" name="PHONE" />
      <column type="date-time" name="OBSOLETE_TIME"/>
      <column type="ref" name="OBSOLETE_BY">
        <otherTable ref="SEC_USR_TBL" />
      </column>
    </table>

    <table name="ENT_TBL">
      <column type="uuid" notNull="true" unique="true" key="true" name="ENT_ID" />
      <column type="uuid" notNull="true" unique="true" name="VERSION" />
      <column type="string" index="true" notNull="true" name="CLASS" />
      <column type="string" notNull="true" name="DETERMINER" />
      <column type="string" name="TYPE" />
      <column type="string" name="TEMPLATE" />
      <column type="decimal" name="LAT"/>
      <column type="decimal" name="LNG"/>
      <column type="date-time" notNull="true" name="CREATED_TIME"/>
      <column type="ref" notNull="true" name="CREATED_BY">
        <otherTable ref="SEC_USR_TBL" />
      </column>
      <column type="date-time" name="OBSOLETE_TIME"/>
      <column type="ref" name="OBSOLETE_BY">
        <otherTable ref="SEC_USR_TBL" />
      </column>
    </table>

    <table name="ENT_ID_TBL">
      <column type="uuid" key="true" name="ID_ID" />
      <column type="ref" index="true" name="ENT_ID">
        <otherTable ref="ENT_TBL"/>
      </column>
      <column type="string" notNull="true" name="ISSUER" />
      <column type="string" notNull="true" name="VALUE" />
      <column type="string" name="CHECK_DIGIT" />
      <column type="date" name="ISSUED" />
      <column type="date" name="EXPIRY" />
    </table>

    <table name="ENT_ADDR_TBL">
      <column type="uuid" key="true" name="ADDR_ID" />
      <column type="ref" index="true" name="ENT_ID">
        <otherTable ref="ENT_TBL"/>
      </column>
      <column type="string" name="USE_TYPE" />
      <column type="string" name="ADDR_TYPE" />
      <column type="string" name="ADDR_STREET" />
      <column type="string" name="ADDR_PRECINCT" />
      <column type="string" name="ADDR_CITY" />
      <column type="string" name="ADDR_COUNTY" />
      <column type="string" name="ADDR_STATE" />
      <column type="string" name="ADDR_COUNTRY" />
      <column type="string" name="ADDR_POSTAL" />
      <column type="string" name="ADDR_CENSUS" />
    </table>

    <table name="ENT_NAME_TBL">
      <column type="uuid" key="true" name="NAME_ID" />
      <column type="ref" index="true" name="ENT_ID">
        <otherTable ref="ENT_TBL"/>
      </column>
      <column type="string" notNull="true" name="USE_TYPE" />
      <column type="string" name="NAME" />
      <column type="string" name="NAME_PREFIX" />
      <column type="string" name="NAME_GIVEN" />
      <column type="string" name="NAME_SUFFIX" />
      <column type="string" name="NAME_FAMILY" />
    </table>


    <table name="ORG_TBL">
      <column type="ref" name="NAME">
        <otherTable ref="ENT_NAME_TBL" />
      </column>
      <column type="ref" name="ADDR">
        <otherTable ref="ENT_ADDR_TBL" />
      </column>
      <column type="string" name="INDUSTRY" />
      <parent ref="ENT_TBL" />
    </table>

    <table name="MAT_TBL">
      <column type="string" name="NAME" />
      <parent ref="ENT_TBL" />
    </table>

    <table name="MMAT_TBL">
      <column type="string" name="LOT" />
      <column type="string" name="GTIN" />
      <column type="ref" name="MANUFACTURER">
        <otherTable ref="ORG_TBL" />
      </column>
      <parent ref="MAT_TBL" />
    </table>

    <table name="PLC_TBL">
      <column type="ref" name="NAME">
        <otherTable ref="ENT_NAME_TBL" />
      </column>
      <column type="ref" name="ADDR">
        <otherTable ref="ENT_ADDR_TBL" />
      </column>
      <column type="string" name="TEL" />
      <parent ref="ENT_TBL" />
    </table>

    <table name="PSN_TBL">
      <column type="ref" name="NAME">
        <otherTable ref="ENT_NAME_TBL" />
      </column>
      <column type="ref" name="ADDR">
        <otherTable ref="ENT_ADDR_TBL" />
      </column>
      <column type="string" name="TEL_HOME" />
      <column type="string" name="TEL_WORK" />
      <column type="string" name="TEL_CELL" />
      <column type="date" index="true" name="DOB" />
      <column type="date" name="DECEASED" />
      <column type="string" name="GENDER" />
      <column type="string" name="PRIMARY_LANGUAGE" />
      <column type="string" name="OCCUPATION" />
      <column type="string" name="VIP" />
      <column type="string" name="NATIONALITY" />
      <column type="ref" name="DEDICATED_FACILITY">
        <otherTable ref="PLC_TBL" />
      </column>
      <parent ref="ENT_TBL" />
    </table>

    <table name="PAT_TBL">
      <column type="int" name="MB_ORD" />
      <column type="string" name="LIVING_ARR" />
      <column type="string" name="RELIGION" />
      <column type="string" name="EHT_GROUP" />
      <column type="string" name="EDUCATION" />
      <column type="ref" name="MOTHER">
        <otherTable ref="PSN_TBL" />
      </column>
      <column type="ref" name="FATHER">
        <otherTable ref="PSN_TBL" />
      </column>
      <column type="ref" name="GUARDIAN">
        <otherTable ref="PSN_TBL" />
      </column>
      <column type="ref" name="REGISTRATION_FACILITY">
        <otherTable ref="PLC_TBL" />
      </column>
      <column type="ref" name="BIRTHPLACE">
        <otherTable ref="PLC_TBL" />
      </column>
      <column type="ref" name="CITIZENSHIP">
        <otherTable ref="PLC_TBL" />
      </column>
      <column type="ref" name="SCHOOL">
        <otherTable ref="ORG_TBL" />
      </column>
      <parent ref="PSN_TBL" />
    </table>

    <table name="USR_TBL">
      <column type="string" name="USERNAME" />
      <parent ref="PSN_TBL" />
    </table>

    <table name="PVD_TBL">
      <column type="ref" name="USER">
        <otherTable ref="USR_TBL" />
      </column>
      <parent ref="PSN_TBL" />
    </table>

    <table name="ACT_TBL">
      <column type="uuid" key="true" unique="true" notNull="true" name="ACT_ID" />
      <column type="uuid" notNull="true" unique="true" name="VERSION" />
      <column type="string" index="true" notNull="true" name="CLASS" />
      <column type="string" name="TEMPLATE" />
      <column type="string" notNull="true" name="MOOD" />
      <column type="string" notNull="true" name="STATUS" />
      <column type="bool" notNull="true" name="NEGATED" />
      <column type="string" name="TYPE" />
      <column type="date-time" name="ACT_TIME" />
      <column type="date-time" name="START_TIME" />
      <column type="date-time" name="STOP_TIME" />
      <column type="decimal" name="LAT"/>
      <column type="decimal" name="LNG"/>
      <column type="date-time" notNull="true" name="CREATED_TIME"/>
      <column type="ref" notNull="true" name="CREATED_BY">
        <otherTable ref="SEC_USR_TBL" />
      </column>
      <column type="date-time" name="OBSOLETE_TIME"/>
      <column type="ref" name="OBSOLETE_BY">
        <otherTable ref="SEC_USR_TBL" />
      </column>
      <column type="ref" notNull="true" name="RECORD_TARGET">
        <otherTable ref="ENT_TBL" />
      </column>
      <column type="ref" name="AUTHOR">
        <otherTable ref="ENT_TBL" />
      </column>
      <column type="ref" name="PERFORMER">
        <otherTable ref="ENT_TBL" />
      </column>
    </table>

    <table name="ACT_ID_TBL">
      <column type="uuid" key="true" name="ID_ID" />
      <column type="ref" index="true" name="ACT_ID">
        <otherTable ref="ACT_TBL"/>
      </column>
      <column type="string" notNull="true" name="ISSUER" />
      <column type="string" notNull="true" name="VALUE" />
      <column type="string" name="CHECK_DIGIT" />
      <column type="date" name="ISSUED" />
      <column type="date" name="EXPIRY" />
    </table>

    <table name="OBS_TBL">
      <column type="string" name="INTERPRETATION"/>
      <column type="string" name="VALUE_STR" />
      <column type="decimal" name="VALUE_QTY" />
      <column type="string" name="UNIT_OF_MEASURE" />
      <parent ref="ACT_TBL" />
    </table>

    <table name="PAT_ENC_TBL">
      <column type="string" name="DISPOSITION" />
      <column type="string" name="ADM_SOURCE" />
      <parent ref="ACT_TBL" />
    </table>

    <table name="PAT_ENC_ARG_TBL">
      <column type="uuid" key="true" unique="true" name="ARG_ID" />
      <column type="string" name="TYPE" />
      <column type="date-time" name="START" />
      <column type="date-time" name="STOP" />
      <column type="ref" name="ACT_ID">
        <otherTable ref="PAT_ENC_TBL" />
      </column>
    </table>

    <table name="SUB_ADM_TBL">
      <column type="string" name="SITE" />
      <column type="string" name="ROUTE"/>
      <column type="decimal" name="DOSE" />
      <column type="string" name="DOSE_UNIT"/>
      <column type="int" name="SEQUENCE" />
      <column type="ref" name="PRODUCT">
        <otherTable ref="MAT_TBL"/>
      </column>
      <parent ref="ACT_TBL" />
    </table>

    <table name="SUB_ADM_CONS_TBL">
      <column type="uuid" key="true" unique="true" notNull="true" name="REL_ID"/>
      <column type="ref" name="ACT_ID">
        <otherTable ref="SUB_ADM_TBL" />
      </column>
      <column type="ref" name="CONSUMED">
        <otherTable ref="MMAT_TBL" />
      </column>
      <column type="int" name="QTY" />
    </table>

  </schema>

  <dataFlows>
    <flow name="users" ref="#org.santedb.bi.datamart.core.users" />
    <flow name="addresses" ref="#org.santedb.bi.datamart.core.addresses" />
    <flow name="names" ref="#org.santedb.bi.datamart.core.names" />
    <flow name="identifiers" ref="#org.santedb.bi.datamart.core.identifiers" />
    <flow name="entities" ref="#org.santedb.bi.datamart.core.entities" />
    <flow name="acts" ref="#org.santedb.bi.datamart.core.acts" />

    <flow name="main">
      <pipeline>
        <log name="log_hello" priority="Informational">
          {{$principal}} is refreshing {{$targetMart}}
        </log>
        <connection name="warehouseDatabase" mode="read-write">
          <dataSource ref="#org.santedb.bi.dataSource.warehouse" />
        </connection>
        <connection name="mainDatabase" mode="read-only">
          <dataSource ref="#org.santedb.bi.dataSource.main" />
        </connection>
        <transaction name="main_transaction">
          <connection ref="warehouseDatabase" />
          <pipeline>
            <call>
              <dataFlow ref="users" />
              <args>
                <ref name="input">
                  <value ref="mainDatabase" />
                </ref>
                <ref name="output">
                  <value ref="warehouseDatabase" />
                </ref>
              </args>
            </call>
            <call>
              <dataFlow ref="entities" />
              <args>
                <ref name="input">
                  <value ref="mainDatabase" />
                </ref>
                <ref name="output">
                  <value ref="warehouseDatabase" />
                </ref>
              </args>
            </call>
            <call>
              <dataFlow ref="acts" />
              <args>
                <ref name="input">
                  <value ref="mainDatabase" />
                </ref>
                <ref name="output">
                  <value ref="warehouseDatabase" />
                </ref>
              </args>
            </call>
            <call>
              <dataFlow ref="identifiers" />
              <args>
                <ref name="input">
                  <value ref="mainDatabase" />
                </ref>
                <ref name="output">
                  <value ref="warehouseDatabase" />
                </ref>
              </args>
            </call>
            <call>
              <dataFlow ref="addresses" />
              <args>
                <ref name="input">
                  <value ref="mainDatabase" />
                </ref>
                <ref name="output">
                  <value ref="warehouseDatabase" />
                </ref>
              </args>
            </call>
            <call>
              <dataFlow ref="names" />
              <args>
                <ref name="input">
                  <value ref="mainDatabase" />
                </ref>
                <ref name="output">
                  <value ref="warehouseDatabase" />
                </ref>
              </args>
            </call>
          </pipeline>
        </transaction>
      </pipeline>
    </flow>
    
  </dataFlows>

</BiDatamartDefinition>